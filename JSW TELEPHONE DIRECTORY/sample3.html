<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Employee Directory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Preload critical resources -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style">
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" as="script">
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" as="script">
  <link rel="preload" href="jsw.png" as="image">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { display: flex; min-height: 100vh; }
    .sidebar {
      width: 200px;
      background-color: #343a40;
      color: white;
      padding: 20px;
    }
    .sidebar a {
      display: block;
      color: white;
      margin: 10px 0;
      text-decoration: none;
    }
    .sidebar a:hover {
      color: #adb5bd;
    }
    .content {
      flex: 1;
      padding: 20px;
    }
    .hidden { display: none; }
    #empTable th {
      cursor: pointer;
    }
    #empTable th:hover {
      background-color: #f8f9fa;
      color: #212529;
    }
    .top-right-image {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 100px;
      height: auto;
    }
    .department-selector {
      margin-bottom: 15px;
      max-width: 300px;
    }
    .search-options {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .search-options .btn {
      flex: 1;
    }
    .dept-details {
      font-size: 0.9em;
      color: #6c757d;
    }
    .sheet-dept {
      font-size: 0.8em;
      color: #495057;
      font-style: italic;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
  </div>
  
  <img src="jsw.png" alt="Logo" class="top-right-image">

  <!-- Sidebar -->
  <div class="sidebar">
    <h4>Menu</h4>
    <a href="#" onclick="showHome()">User</a>
    <a href="#" onclick="showSearchOptions()">Search</a>
    <a href="#" onclick="showAdminLogin()">Admin</a>
    <a href="index.html">Home</a>
  </div>

  <!-- Main Content -->
  <div class="content">
    <!-- Employee Directory -->
    <div id="home-section">
      <h3>Employee Directory</h3>
      
      <div class="department-selector">
        <select id="departmentSelect" class="form-select" onchange="filterByDepartment()">
          <option value="">Select Department</option>
          <!-- Departments will be loaded dynamically -->
        </select>
      </div>
      
      <div class="input-group mb-3">
        <input type="text" id="search" class="form-control" placeholder="Search by name or extension number..." />
        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">Clear</button>
      </div>
      
      <div class="table-responsive">
        <table class="table table-bordered table-hover" id="empTable">
          <thead class="table-dark">
            <tr>
              <th onclick="sortTable(0)">Name <span id="sort0">↕</span></th>
              <th onclick="sortTable(1)">Department <span id="sort1">↕</span></th>
              <th onclick="sortTable(2)">Extension Number <span id="sort2">↕</span></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Search Options -->
    <div id="search-options-section" class="hidden">
      <h3>Search Options</h3>
      <div class="search-options">
        <button class="btn btn-primary" onclick="setSearchMode('department')">Search by Department</button>
        <button class="btn btn-primary" onclick="setSearchMode('name')">Search by Name</button>
        <button class="btn btn-primary" onclick="setSearchMode('extn')">Search by Extension</button>
      </div>
      
      <div id="search-by-department" class="hidden">
        <div class="department-selector">
          <select id="searchDeptSelect" class="form-select" onchange="searchByDepartment()">
            <option value="">Select Department</option>
            <!-- Departments will be loaded dynamically -->
          </select>
        </div>
      </div>
      
      <div id="search-by-name" class="hidden">
        <div class="input-group mb-3">
          <input type="text" id="searchNameInput" class="form-control" placeholder="Enter name to search..." />
          <button class="btn btn-outline-secondary" type="button" onclick="clearNameSearch()">Clear</button>
        </div>
      </div>
      
      <div id="search-by-extn" class="hidden">
        <div class="input-group mb-3">
          <input type="text" id="searchExtnInput" class="form-control" placeholder="Enter extension number to search..." />
          <button class="btn btn-outline-secondary" type="button" onclick="clearExtnSearch()">Clear</button>
        </div>
      </div>
      
      <div class="table-responsive">
        <table class="table table-bordered table-hover" id="searchResultsTable">
          <thead class="table-dark">
            <tr>
              <th>Name</th>
              <th>Department</th>
              <th>Extension Number</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Admin Login -->
    <div id="admin-login" class="hidden">
      <div class="card" style="max-width: 500px; margin: 0 auto;">
        <div class="card-header bg-dark text-white">
          <h3 class="mb-0">Admin Login</h3>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label for="adminUser" class="form-label">Username</label>
            <input id="adminUser" class="form-control" placeholder="Enter username" />
          </div>
          <div class="mb-3">
            <label for="adminPass" class="form-label">Password</label>
            <input id="adminPass" type="password" class="form-control" placeholder="Enter password" />
          </div>
          <button class="btn btn-dark w-100" onclick="adminLogin()">Login</button>
          <div id="adminError" class="text-danger mt-2 text-center"></div>
        </div>
      </div>
    </div>
    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden">
      <div class="card">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <h3 class="mb-0">Admin Panel</h3>
          <button class="btn btn-sm btn-danger" onclick="logoutAdmin()">Logout</button>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-3">
              <button class="btn btn-success w-100" onclick="showAddModal()">Add Employee</button>
            </div>
            <div class="col-md-3">
              <button class="btn btn-warning w-100" onclick="showDeleteModal()">Delete Employee</button>
            </div>
            <div class="col-md-3">
              <button class="btn btn-primary w-100" onclick="showUpdateModal()">Update Employee</button>
            </div>
            <div class="col-md-3">
              <button class="btn btn-info w-100" onclick="exportToExcel()">Export to Excel</button>
            </div>
            <div class="mb-3">
              <label for="upload" class="form-label">Upload Excel File</label>
              <input type="file" id="upload" class="form-control" accept=".xlsx,.xls" />
            </div>
          </div>
          
          <!-- Add Employee Modal -->
          <div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Add New Employee</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label class="form-label">Name</label>
                    <input id="addName" class="form-control" />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Department</label>
                    <input id="addDept" class="form-control" />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Sheet Department (if different)</label>
                    <input id="addSheetDept" class="form-control" />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Department Details</label>
                    <input id="addDeptDetail" class="form-control" />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Extension Number</label>
                    <input id="addExt" class="form-control" />
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-primary" onclick="addEmployee()">Add Employee</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Delete Employee Modal -->
          <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Delete Employee</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label class="form-label">Select Employee to Delete</label>
                    <select id="deleteSelect" class="form-select">
                      <!-- Options will be added dynamically -->
                    </select>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-danger" onclick="deleteEmployee()">Delete Employee</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Update Employee Modal -->
          <div class="modal fade" id="updateModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Update Employee</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label class="form-label">Select Employee to Update</label>
                    <select id="updateSelect" class="form-select" onchange="loadEmployeeData()">
                      <!-- Options will be added dynamically -->
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Name</label>
                    <input id="updateName" class="form-control" />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Department</label>
                    <input id="updateDept" class="form-control" />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Sheet Department</label>
                    <input id="updateSheetDept" class="form-control" />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Department Details</label>
                    <input id="updateDeptDetail" class="form-control" />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Extension Number</label>
                    <input id="updateExt" class="form-control" />
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-primary" onclick="updateEmployee()">Update Employee</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let allEmployeeData = [];
    let defaultDepartment = "ADMINISTRATIVE OFFICE"; // Add this near the top with other variables
    let filteredEmployeeData = [];
    let departments = [];
    let sortDirections = [1, 1, 1]; // 1 = ascending, -1 = descending
    let adminLoggedIn = false;
    let currentSearchMode = null;
    let departmentDetails = {};
    let currentPage = 1;
    const rowsPerPage = 50;
    let paginatedData = [];

    // Add this near your other variables
let lastModifiedTime = null;
let pollingInterval = 30000; // Check every 30 seconds

// Start polling after initial load
function startPolling() {
  setInterval(checkForUpdates, pollingInterval);
}

function checkForUpdates() {
  fetch("new telephone.xls", { method: 'HEAD' })
    .then(res => {
      const lastModified = new Date(res.headers.get('Last-Modified'));
      if (!lastModifiedTime) {
        lastModifiedTime = lastModified;
        return;
      }
      
      if (lastModified > lastModifiedTime) {
        console.log('File changed, reloading data...');
        lastModifiedTime = lastModified;
        reloadData();
      }
    })
    .catch(err => console.error('Error checking for updates:', err));
}

function reloadData() {
  showLoader();
  fetch("new telephone.xls")
    .then(res => res.arrayBuffer())
    .then(ab => {
      const workbook = XLSX.read(ab, { type: "array" });
      processWorkbook(workbook);
      hideLoader();
    })
    .catch(err => {
      console.error("Error reloading Excel file:", err);
      hideLoader();
    });
}

// Call this after your initial data load
startPolling();

    // Initialize modals
    let addModal = null;
    let deleteModal = null;
    let updateModal = null;

    function showLoader() {
      document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoader() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    // Debounce function to limit how often a function is called
    function debounce(func, wait) {
      let timeout;
      return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          func.apply(context, args);
        }, wait);
      };
    }

    document.addEventListener('DOMContentLoaded', function() {
      addModal = new bootstrap.Modal(document.getElementById('addModal'));
      deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
      updateModal = new bootstrap.Modal(document.getElementById('updateModal'));

      showLoader();
      
      // Load data from Excel file
      fetch("new telephone.xls")
        .then(res => res.arrayBuffer())
        .then(ab => {
          const workbook = XLSX.read(ab, { type: "array" });
          processWorkbook(workbook);
          hideLoader();
        })
        .catch(err => {
          console.error("Error loading Excel file:", err);
          hideLoader();
          renderTable([]);
          renderSearchResults([]);
        });

      // Add optimized event listeners
      document.getElementById("search").addEventListener("input", debounce(function() {
        filterTable(this.value);
      }, 300));

      document.getElementById("searchNameInput").addEventListener("input", debounce(function() {
        searchByName();
      }, 300));

      document.getElementById("searchExtnInput").addEventListener("input", debounce(function() {
        searchByExtn();
      }, 300));

      document.getElementById('upload').addEventListener('change', function(e) {
        showLoader();
        const reader = new FileReader();
        reader.onload = function(e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          processWorkbook(workbook);
          hideLoader();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
      });
    });

    function processWorkbook(workbook) {
  allEmployeeData = [];
  departments = [];
  departmentDetails = {};
  
  // Find ADMINISTRATIVE OFFICE sheet and process it first
  const adminSheetName = workbook.SheetNames.find(name => 
    name.toString().toUpperCase().includes("ADMINISTRATIVE OFFICE")
  );
  
  // Process ADMINISTRATIVE OFFICE sheet if found
  if (adminSheetName) {
    const sheet = workbook.Sheets[adminSheetName];
    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
    
    // Get department info from row 1 (0-indexed)
    const sheetDeptName = (jsonData[1] && jsonData[1][1]) ? jsonData[1][1].toString().trim() : adminSheetName;
    const sheetDeptDetail = (jsonData[1] && jsonData[1][2]) ? jsonData[1][2].toString().trim() : '';
    
    // Store department details
    departmentDetails[sheetDeptName] = sheetDeptDetail;
    
    // Add to departments list if not already present
    if (!departments.includes(sheetDeptName)) {
      departments.push(sheetDeptName);
    }
    
    // Process employee data starting from row 3 (0-indexed)
    for(let rowNum = 3; rowNum < jsonData.length; rowNum++) {
      const row = jsonData[rowNum];
      if(row && row[1]) { // Column B (Name)
        const empDept = (row[2] && row[2].toString().trim()) || sheetDeptName;
        const extn = row[4] ? row[4].toString().trim() : '-';
        
        allEmployeeData.push({
          "Name": row[1].toString().trim(),
          "Dept": empDept,
          "DeptDetail": departmentDetails[sheetDeptName] || '',
          "Extn Number": extn,
          "SheetDept": sheetDeptName
        });
      }
    }
  }
  
  // Process remaining sheets (excluding the ADMINISTRATIVE OFFICE sheet we already processed)
  workbook.SheetNames.forEach(sheetName => {
    // Skip if this is the ADMINISTRATIVE OFFICE sheet we already processed
    if (adminSheetName && sheetName === adminSheetName) return;
    
    const sheet = workbook.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
    
    // Get department info from row 1 (0-indexed)
    const sheetDeptName = (jsonData[1] && jsonData[1][1]) ? jsonData[1][1].toString().trim() : sheetName;
    const sheetDeptDetail = (jsonData[1] && jsonData[1][2]) ? jsonData[1][2].toString().trim() : '';
    
    // Store department details
    departmentDetails[sheetDeptName] = sheetDeptDetail;
    
    // Add to departments list if not already present
    if (!departments.includes(sheetDeptName)) {
      departments.push(sheetDeptName);
    }
    
    // Process employee data starting from row 3 (0-indexed)
    for(let rowNum = 3; rowNum < jsonData.length; rowNum++) {
      const row = jsonData[rowNum];
      if(row && row[1]) { // Column B (Name)
        const empDept = (row[2] && row[2].toString().trim()) || sheetDeptName;
        const extn = row[4] ? row[4].toString().trim() : '-';
        
        allEmployeeData.push({
          "Name": row[1].toString().trim(),
          "Dept": empDept,
          "DeptDetail": departmentDetails[sheetDeptName] || '',
          "Extn Number": extn,
          "SheetDept": sheetDeptName
        });
      }
    }
  });
  
  // Sort departments alphabetically
  departments.sort((a, b) => a.localeCompare(b));
  
  // Optimize dropdown population
  populateDepartmentDropdowns();
  
  // Initialize filtered data and render table
  filteredEmployeeData = [...allEmployeeData];
  
  // Set the department select to ADMINISTRATIVE OFFICE if it exists
  if (adminSheetName) {
    const sheetDeptName = (workbook.Sheets[adminSheetName][1] && workbook.Sheets[adminSheetName][1][1]) ? 
      workbook.Sheets[adminSheetName][1][1].toString().trim() : adminSheetName;
    document.getElementById("departmentSelect").value = sheetDeptName;
    filterByDepartment();
  } else {
    renderTable(filteredEmployeeData);
  }
}

    function populateDepartmentDropdowns() {
      const deptSelect = document.getElementById('departmentSelect');
      const searchDeptSelect = document.getElementById('searchDeptSelect');
      
      // Create document fragment for better performance
      const fragment1 = document.createDocumentFragment();
      const fragment2 = document.createDocumentFragment();
      
      const defaultOption1 = document.createElement('option');
      defaultOption1.value = "";
      defaultOption1.textContent = "Select Department";
      fragment1.appendChild(defaultOption1.cloneNode(true));
      fragment2.appendChild(defaultOption1.cloneNode(true));
      
      departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = departmentDetails[dept] ? `${dept} (${departmentDetails[dept]})` : dept;
        fragment1.appendChild(option.cloneNode(true));
        fragment2.appendChild(option.cloneNode(true));
      });
      
      // Clear and append in one operation
      deptSelect.innerHTML = '';
      searchDeptSelect.innerHTML = '';
      deptSelect.appendChild(fragment1);
      searchDeptSelect.appendChild(fragment2);
    }

    function renderTable(data) {
      filteredEmployeeData = data;
      currentPage = 1;
      paginateData();
    }

    function paginateData() {
      const startIdx = (currentPage - 1) * rowsPerPage;
      const endIdx = startIdx + rowsPerPage;
      paginatedData = filteredEmployeeData.slice(startIdx, endIdx);
      renderTableBody(paginatedData);
      renderPaginationControls();
    }

    function renderTableBody(data) {
      const tbody = document.querySelector("#empTable tbody");
      const fragment = document.createDocumentFragment();
      
      if (data.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="3" class="text-center">No data available</td>';
        fragment.appendChild(tr);
      } else {
        data.forEach(emp => {
          const tr = document.createElement('tr');
          
          // Name cell
          const nameTd = document.createElement('td');
          nameTd.textContent = emp["Name"];
          
          // Department cell
          const deptTd = document.createElement('td');
          const deptDiv = document.createElement('div');
          deptDiv.textContent = emp["Dept"];
          deptTd.appendChild(deptDiv);
          
          // Add sheet department if different
          if (emp["SheetDept"] && emp["SheetDept"] !== emp["Dept"]) {
            const sheetDeptDiv = document.createElement('div');
            sheetDeptDiv.className = "sheet-dept";
            sheetDeptDiv.textContent = `Sheet Department: ${emp["SheetDept"]}`;
            deptTd.appendChild(sheetDeptDiv);
          }
          
          // Add department details if available
          const deptDetail = departmentDetails[emp["SheetDept"]] || '';
          if (deptDetail) {
            const detailDiv = document.createElement('div');
            detailDiv.className = "dept-details";
            detailDiv.textContent = deptDetail;
            deptTd.appendChild(detailDiv);
          }
          
          // Extension cell
          const extTd = document.createElement('td');
          extTd.textContent = emp["Extn Number"];
          
          // Append all cells to row
          tr.appendChild(nameTd);
          tr.appendChild(deptTd);
          tr.appendChild(extTd);
          
          fragment.appendChild(tr);
        });
      }
      
      // Clear and append in one operation
      tbody.innerHTML = '';
      tbody.appendChild(fragment);
    }

    function renderPaginationControls() {
      const totalPages = Math.ceil(filteredEmployeeData.length / rowsPerPage);
      const paginationDiv = document.createElement('div');
      paginationDiv.className = 'd-flex justify-content-center mt-3';
      
      if (totalPages > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.className = 'btn btn-sm btn-outline-primary mx-1';
        prevBtn.textContent = 'Previous';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            paginateData();
          }
        };
        
        const pageInfo = document.createElement('span');
        pageInfo.className = 'mx-2 align-self-center';
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        
        const nextBtn = document.createElement('button');
        nextBtn.className = 'btn btn-sm btn-outline-primary mx-1';
        nextBtn.textContent = 'Next';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => {
          if (currentPage < totalPages) {
            currentPage++;
            paginateData();
          }
        };
        
        paginationDiv.appendChild(prevBtn);
        paginationDiv.appendChild(pageInfo);
        paginationDiv.appendChild(nextBtn);
      }
      
      // Remove old pagination if it exists
      const oldPagination = document.querySelector('.pagination-controls');
      if (oldPagination) oldPagination.remove();
      
      paginationDiv.classList.add('pagination-controls');
      document.querySelector('.table-responsive').after(paginationDiv);
    }

    function renderSearchResults(data) {
      const tbody = document.querySelector("#searchResultsTable tbody");
      const fragment = document.createDocumentFragment();
      
      if (data.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="3" class="text-center">No results found</td>';
        fragment.appendChild(tr);
      } else {
        data.forEach(emp => {
          const tr = document.createElement('tr');
          
          // Name cell
          const nameTd = document.createElement('td');
          nameTd.textContent = emp["Name"];
          
          // Department cell
          const deptTd = document.createElement('td');
          const deptDiv = document.createElement('div');
          deptDiv.textContent = emp["Dept"];
          deptTd.appendChild(deptDiv);
          
          // Add sheet department if different
          if (emp["SheetDept"] && emp["SheetDept"] !== emp["Dept"]) {
            const sheetDeptDiv = document.createElement('div');
            sheetDeptDiv.className = "sheet-dept";
            sheetDeptDiv.textContent = `Sheet Department: ${emp["SheetDept"]}`;
            deptTd.appendChild(sheetDeptDiv);
          }
          
          // Add department details if available
          const deptDetail = departmentDetails[emp["SheetDept"]] || '';
          if (deptDetail) {
            const detailDiv = document.createElement('div');
            detailDiv.className = "dept-details";
            detailDiv.textContent = deptDetail;
            deptTd.appendChild(detailDiv);
          }
          
          // Extension cell
          const extTd = document.createElement('td');
          extTd.textContent = emp["Extn Number"];
          
          // Append all cells to row
          tr.appendChild(nameTd);
          tr.appendChild(deptTd);
          tr.appendChild(extTd);
          
          fragment.appendChild(tr);
        });
      }
      
      // Clear and append in one operation
      tbody.innerHTML = '';
      tbody.appendChild(fragment);
    }

    function filterTable(query) {
      const q = query.toLowerCase();
      const filtered = allEmployeeData.filter(emp =>
        (emp["Name"] && emp["Name"].toLowerCase().includes(q)) ||
        (emp["Extn Number"] && emp["Extn Number"].toString().toLowerCase().includes(q))
      );
      filteredEmployeeData = filtered;
      renderTable(filtered);
    }

    function clearSearch() {
      document.getElementById("search").value = "";
      filteredEmployeeData = [...allEmployeeData];
      renderTable(filteredEmployeeData);
    }

    function sortTable(columnIndex) {
      const columnMap = {
        0: "Name",
        1: "Dept",
        2: "Extn Number"
      };
      const columnName = columnMap[columnIndex];
      
      sortDirections[columnIndex] *= -1;
      const direction = sortDirections[columnIndex];
      
      filteredEmployeeData.sort((a, b) => {
        let valA = a[columnName];
        let valB = b[columnName];
        
        // Convert to numbers if possible for Extn Number
        if (columnIndex === 2) {
          valA = isNaN(valA) ? valA : Number(valA);
          valB = isNaN(valB) ? valB : Number(valB);
        }
        
        if (valA < valB) return -1 * direction;
        if (valA > valB) return 1 * direction;
        return 0;
      });
      
      // Update sort indicators
      for (let i = 0; i < 3; i++) {
        const span = document.getElementById(`sort${i}`);
        if (i === columnIndex) {
          span.textContent = direction === 1 ? '↑' : '↓';
        } else {
          span.textContent = '↕';
        }
      }
      
      renderTable(filteredEmployeeData);
    }

    function filterByDepartment() {
      const deptSelect = document.getElementById("departmentSelect");
      const selectedDept = deptSelect.value;
      
      if (!selectedDept) {
        filteredEmployeeData = [...allEmployeeData];
      } else {
        // Filter by sheet department (from B2 cell)
        filteredEmployeeData = allEmployeeData.filter(emp => 
          emp["SheetDept"] === selectedDept
        );
      }
      
      renderTable(filteredEmployeeData);
    }

    // Search functions
    function showSearchOptions() {
      document.getElementById("home-section").classList.add("hidden");
      document.getElementById("search-options-section").classList.remove("hidden");
      document.getElementById("admin-login").classList.add("hidden");
      document.getElementById("admin-panel").classList.add("hidden");
      
      // Reset search options
      document.getElementById("search-by-department").classList.add("hidden");
      document.getElementById("search-by-name").classList.add("hidden");
      document.getElementById("search-by-extn").classList.add("hidden");
      renderSearchResults([]);
    }

    function setSearchMode(mode) {
      currentSearchMode = mode;
      
      // Hide all search inputs
      document.getElementById("search-by-department").classList.add("hidden");
      document.getElementById("search-by-name").classList.add("hidden");
      document.getElementById("search-by-extn").classList.add("hidden");
      
      // Show the selected one
      if (mode === 'department') {
        document.getElementById("search-by-department").classList.remove("hidden");
        document.getElementById("searchDeptSelect").value = "";
      } else if (mode === 'name') {
        document.getElementById("search-by-name").classList.remove("hidden");
        document.getElementById("searchNameInput").value = "";
      } else if (mode === 'extn') {
        document.getElementById("search-by-extn").classList.remove("hidden");
        document.getElementById("searchExtnInput").value = "";
      }
      
      renderSearchResults([]);
    }

    function searchByDepartment() {
      const deptSelect = document.getElementById("searchDeptSelect");
      const selectedDept = deptSelect.value;
      
      if (!selectedDept) {
        renderSearchResults([]);
        return;
      }
      
      // Search by sheet department (from B2 cell)
      const results = allEmployeeData.filter(emp => 
        emp.SheetDept === selectedDept
      );
      
      renderSearchResults(results);
    }

    function searchByName() {
      const input = document.getElementById("searchNameInput");
      const query = input.value.toLowerCase().trim();
      
      if (!query) {
        renderSearchResults([]);
        return;
      }
      
      // Search through all employee data
      const results = allEmployeeData.filter(emp => {
        return emp["Name"] && emp["Name"].toLowerCase().includes(query);
      });
      
      renderSearchResults(results);
    }

    function searchByExtn() {
      const input = document.getElementById("searchExtnInput");
      const query = input.value.trim();
      
      if (!query) {
        renderSearchResults([]);
        return;
      }
      
      const results = allEmployeeData.filter(emp => 
        emp["Extn Number"] && emp["Extn Number"].toString().includes(query)
      );
      
      renderSearchResults(results);
    }

    function clearNameSearch() {
      document.getElementById("searchNameInput").value = "";
      renderSearchResults([]);
    }

    function clearExtnSearch() {
      document.getElementById("searchExtnInput").value = "";
      renderSearchResults([]);
    }

    // Admin system
    function showHome() {
      document.getElementById("home-section").classList.remove("hidden");
      document.getElementById("search-options-section").classList.add("hidden");
      document.getElementById("admin-login").classList.add("hidden");
      document.getElementById("admin-panel").classList.add("hidden");
    }

    function showAdminLogin() {
      document.getElementById("home-section").classList.add("hidden");
      document.getElementById("search-options-section").classList.add("hidden");
      document.getElementById("admin-login").classList.remove("hidden");
      document.getElementById("admin-panel").classList.add("hidden");
      document.getElementById("adminError").textContent = "";
    }

    function adminLogin() {
      const user = document.getElementById("adminUser").value;
      const pass = document.getElementById("adminPass").value;
      
      // In a real application, you would validate against a server
      if (user === "admin" && pass === "admin123") {
        adminLoggedIn = true;
        document.getElementById("admin-login").classList.add("hidden");
        document.getElementById("admin-panel").classList.remove("hidden");
        document.getElementById("adminError").textContent = "";
      } else {
        document.getElementById("adminError").textContent = "Invalid credentials";
      }
    }

    function logoutAdmin() {
      adminLoggedIn = false;
      showHome();
    }

    function showAddModal() {
      document.getElementById("addName").value = "";
      document.getElementById("addDept").value = "";
      document.getElementById("addSheetDept").value = "";
      document.getElementById("addDeptDetail").value = "";
      document.getElementById("addExt").value = "";
      addModal.show();
    }

    function showDeleteModal() {
      const select = document.getElementById("deleteSelect");
      select.innerHTML = "";
      
      // Create a unique list of employees (name + department)
      const uniqueEmployees = [];
      allEmployeeData.forEach(emp => {
        const identifier = `${emp["Name"]}|${emp["Dept"]}`;
        if (!uniqueEmployees.includes(identifier)) {
          uniqueEmployees.push(identifier);
          const option = document.createElement("option");
          option.value = identifier;
          option.textContent = `${emp["Name"]} (${emp["Dept"]})`;
          select.appendChild(option);
        }
      });
      
      deleteModal.show();
    }

    function showUpdateModal() {
      const select = document.getElementById("updateSelect");
      select.innerHTML = "";
      
      // Create a unique list of employees (name + department)
      const uniqueEmployees = [];
      allEmployeeData.forEach(emp => {
        const identifier = `${emp["Name"]}|${emp["Dept"]}`;
        if (!uniqueEmployees.includes(identifier)) {
          uniqueEmployees.push(identifier);
          const option = document.createElement("option");
          option.value = identifier;
          option.textContent = `${emp["Name"]} (${emp["Dept"]})`;
          select.appendChild(option);
        }
      });
      
      // Load first employee's data if available
      if (uniqueEmployees.length > 0) {
        loadEmployeeData(uniqueEmployees[0]);
      }
      
      updateModal.show();
    }

    function loadEmployeeData(identifier) {
      if (!identifier) {
        identifier = document.getElementById("updateSelect").value;
      }
      
      if (identifier) {
        const [name, dept] = identifier.split("|");
        const emp = allEmployeeData.find(e => e["Name"] === name && e["Dept"] === dept);
        
        if (emp) {
          document.getElementById("updateName").value = emp["Name"] || "";
          document.getElementById("updateDept").value = emp["Dept"] || "";
          document.getElementById("updateSheetDept").value = emp["SheetDept"] || "";
          document.getElementById("updateDeptDetail").value = departmentDetails[emp["SheetDept"]] || "";
          document.getElementById("updateExt").value = emp["Extn Number"] || "";
        }
      }
    }

    function addEmployee() {
      const name = document.getElementById("addName").value.trim();
      const dept = document.getElementById("addDept").value.trim();
      const sheetDept = document.getElementById("addSheetDept").value.trim() || dept;
      const deptDetail = document.getElementById("addDeptDetail").value.trim();
      const ext = document.getElementById("addExt").value.trim();
      
      if (!name) {
        alert("Please enter a name for the employee");
        return;
      }
      
      const newEmp = {
        "Name": name,
        "Dept": dept || "General",
        "DeptDetail": deptDetail || '',
        "Extn Number": ext || "0000",
        "SheetDept": sheetDept
      };
      
      allEmployeeData.push(newEmp);
      
      // Update departments if new sheet department was added
      if (sheetDept && !departments.includes(sheetDept)) {
        departments.push(sheetDept);
        departments.sort((a, b) => a.localeCompare(b));
        
        const deptSelect = document.getElementById('departmentSelect');
        const searchDeptSelect = document.getElementById('searchDeptSelect');
        
        deptSelect.innerHTML = '<option value="">Select Department</option>';
        searchDeptSelect.innerHTML = '<option value="">Select Department</option>';
        
        departments.forEach(dept => {
          const option = document.createElement('option');
          option.value = dept;
          option.textContent = departmentDetails[dept] ? `${dept} (${departmentDetails[dept]})` : dept;
          deptSelect.appendChild(option.cloneNode(true));
          searchDeptSelect.appendChild(option.cloneNode(true));
        });
      }
      
      // Store department details if provided
      if (deptDetail && sheetDept) {
        departmentDetails[sheetDept] = deptDetail;
      }
      
      filterByDepartment();
      addModal.hide();
    }

    function deleteEmployee() {
      const select = document.getElementById("deleteSelect");
      const selectedValue = select.value;
      
      if (selectedValue) {
        const [name, dept] = selectedValue.split("|");
        
        // Find all matching employees and remove them
        allEmployeeData = allEmployeeData.filter(emp => 
          !(emp["Name"] === name && emp["Dept"] === dept)
        );
        
        filterByDepartment();
        deleteModal.hide();
      }
    }

    function updateEmployee() {
      const select = document.getElementById("updateSelect");
      const identifier = select.value;
      
      if (identifier) {
        const [oldName, oldDept] = identifier.split("|");
        const newName = document.getElementById("updateName").value.trim();
        const newDept = document.getElementById("updateDept").value.trim();
        const newSheetDept = document.getElementById("updateSheetDept").value.trim() || newDept;
        const newDeptDetail = document.getElementById("updateDeptDetail").value.trim();
        const newExt = document.getElementById("updateExt").value.trim();
        
        // Update all matching records
        allEmployeeData.forEach(emp => {
          if (emp["Name"] === oldName && emp["Dept"] === oldDept) {
            emp["Name"] = newName;
            emp["Dept"] = newDept;
            emp["SheetDept"] = newSheetDept;
            emp["Extn Number"] = newExt;
          }
        });
        
        // Update departments if new sheet department was added
        if (newSheetDept && !departments.includes(newSheetDept)) {
          departments.push(newSheetDept);
          departments.sort((a, b) => a.localeCompare(b));
          
          const deptSelect = document.getElementById('departmentSelect');
          const searchDeptSelect = document.getElementById('searchDeptSelect');
          
          deptSelect.innerHTML = '<option value="">Select Department</option>';
          searchDeptSelect.innerHTML = '<option value="">Select Department</option>';
          
          departments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept;
            option.textContent = departmentDetails[dept] ? `${dept} (${departmentDetails[dept]})` : dept;
            deptSelect.appendChild(option.cloneNode(true));
            searchDeptSelect.appendChild(option.cloneNode(true));
          });
        }
        
        // Store department details if provided
        if (newDeptDetail && newSheetDept) {
          departmentDetails[newSheetDept] = newDeptDetail;
        }
        
        filterByDepartment();
        updateModal.hide();
      }
    }

    function exportToExcel() {
      if (!allEmployeeData.length) {
        alert("No data to export");
        return;
      }
      
      // Create a new workbook
      const wb = XLSX.utils.book_new();
      
      // Prepare data for export
      const exportData = allEmployeeData.map(emp => ({
        "Name": emp["Name"],
        "Department": emp["Dept"],
        "Sheet Department": emp["SheetDept"],
        "Department Details": departmentDetails[emp["SheetDept"]] || '',
        "Extension Number": emp["Extn Number"]
      }));
      
      const ws = XLSX.utils.json_to_sheet(exportData);
      
      XLSX.utils.book_append_sheet(wb, ws, "Employee Data");
      
      // Generate and download the file
      XLSX.writeFile(wb, `employees_${new Date().toISOString().slice(0,10)}.xlsx`);
    }
  </script>
</body>
</html>